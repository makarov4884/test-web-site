const fs = require('fs');
const path = require('path');

const sourceDir = process.cwd();
const destDir = path.join(sourceDir, 'deploy');

console.log('ðŸš€ Preparing Cloud Build Deployment (Bypassing local build OOM)...');

// 1. Clean deploy directory
if (fs.existsSync(destDir)) {
    fs.rmSync(destDir, { recursive: true, force: true });
}
fs.mkdirSync(destDir);

// 2. Copy Source Code (Excluding heavy/irrelevant files)
const excludes = new Set([
    'node_modules',
    '.next',
    '.git',
    '.vscode',
    'deploy',
    'tmp',
    'worker',
    '.env', // Do not copy raw env files, use Spaces Secrets!
    '.env.local'
]);

// Helper to copy recursive with exclusion
function copyRecursive(src, dest) {
    if (!fs.existsSync(src)) return;
    const stats = fs.statSync(src);
    const name = path.basename(src);

    if (excludes.has(name)) return;

    if (stats.isDirectory()) {
        if (!fs.existsSync(dest)) fs.mkdirSync(dest);
        fs.readdirSync(src).forEach(child => {
            copyRecursive(path.join(src, child), path.join(dest, child));
        });
    } else {
        fs.copyFileSync(src, dest);
    }
}

console.log('ðŸ“¦ Copying source code to deploy folder...');
fs.readdirSync(sourceDir).forEach(child => {
    copyRecursive(path.join(sourceDir, child), path.join(destDir, child));
});

// 3. Ensure signatures.json is up to date in source (it was generated by map script)
// It's already in public/signatures.json, so it's copied.

// 4. Create Dockerfile for Cloud Build
const dockerfileContent = `
FROM node:20-bookworm

WORKDIR /app

# Copy all source files
COPY . .

# Install dependencies
RUN npm ci

# Install Playwright browsers (Required for Crawler)
RUN npx playwright install --with-deps chromium

# Build the project (Cloud Side)
# This bypasses local memory issues
RUN npm run build

# Prepare Standalone directories (Next.js requires manual copy of public/static to standalone)
RUN cp -r public .next/standalone/public || true
RUN mkdir -p .next/standalone/.next/static
RUN cp -r .next/static/* .next/standalone/.next/static/

# Environment
ENV PORT=7860
ENV NODE_ENV=production
EXPOSE 7860

# Start Standalone Server
CMD ["node", ".next/standalone/server.js"]
`;

fs.writeFileSync(path.join(destDir, 'Dockerfile'), dockerfileContent);

// 5. Create README
const readmeContent = `---
title: Team Jinu Support (Cloud Build)
emoji: ðŸš€
colorFrom: blue
colorTo: purple
sdk: docker
app_port: 7860
pinned: false
---

# Team Jinu Support Site

Deployed via Source Upload.
Build runs in the cloud to ensure stability.
`;

fs.writeFileSync(path.join(destDir, 'README.md'), readmeContent);

console.log('âœ… Deployment Pack Ready!');
console.log('ðŸ‘‰ Upload the contents of "deploy" to Hugging Face Spaces.');
console.log('   The build will happen on the server (taking 2-3 mins).');
